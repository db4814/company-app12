<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>经济数据 - 能源装备企业一企一档管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .header-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 20px 20px;
        }
        .company-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            margin-bottom: 20px;
        }
        .company-card:hover {
            transform: translateY(-5px);
        }
        .info-label {
            font-weight: bold;
            color: #555;
        }
        .info-row {
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #eee;
        }
        .back-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            border-radius: 25px;
            padding: 8px 20px;
        }
        .nav-tabs .nav-link.active {
            background-color: #667eea;
            color: white;
            border-color: #667eea;
        }
        .nav-tabs .nav-link {
            color: #667eea;
        }
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        .data-table th {
            background-color: #667eea;
            color: white;
        }
        .quarter-btn {
            margin: 2px;
        }
        .control-panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- 顶部背景区域 -->
    <div class="header-bg">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="display-5 fw-bold">
                        <i class="fas fa-industry me-3"></i>
                        能源装备企业一企一档管理系统
                    </h1>
                    <p class="lead mb-0">全面掌握企业信息，精准调度经济数据</p>
                </div>
                <div class="col-md-4 text-end">
                    <span class="stats-number">{{ company.employee_count or 0 }}</span>
                    <small>员工人数</small>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- 操作按钮区域 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="action-buttons">
                    <a href="/company/{{ company.id }}" class="btn back-btn">
                        <i class="fas fa-arrow-left me-2"></i>返回企业档案
                    </a>
                    <a href="/company/{{ company.id }}/project" class="btn btn-primary">
                        <i class="fas fa-project-diagram me-2"></i>项目信息
                    </a>
                    <a href="/company/{{ company.id }}/annual_comparison" class="btn btn-info">
                        <i class="fas fa-chart-bar me-2"></i>年度对比
                    </a>
                    <a href="/company/{{ company.id }}/comprehensive" class="btn btn-warning">
                        <i class="fas fa-chart-bar me-2"></i>企业综合数据
                    </a>
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#quarterlyModal">
                        <i class="fas fa-calendar-alt me-2"></i>季度数据
                    </button>
                </div>
            </div>
        </div>

        <!-- 控制面板 -->
        <div class="control-panel">
            <div class="row align-items-center">
                <div class="col-md-3">
                    <label class="form-label"><strong>数据类型：</strong></label>
                    <select class="form-select" id="dataTypeSelect" onchange="updateDataType()">
                        <option value="output" {% if data_type == 'output' %}selected{% endif %}>产值数据</option>
                        <option value="capacity" {% if data_type == 'capacity' %}selected{% endif %}>产能数据</option>
                        <option value="tax" {% if data_type == 'tax' %}selected{% endif %}>税收数据</option>
                        <option value="investment" {% if data_type == 'investment' %}selected{% endif %}>固定投资数据</option>
                        <option value="added_value" {% if data_type == 'added_value' %}selected{% endif %}>增加值数据</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label"><strong>年份：</strong></label>
                    <select class="form-select" id="yearSelect" onchange="updateYear()">
                        {% for y in years %}
                        <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}年</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6 text-end">
                    <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#dataInputModal">
                        <i class="fas fa-plus me-2"></i>录入数据
                    </button>
                    <button class="btn btn-success btn-lg" onclick="exportEconomicData()">
                        <i class="fas fa-download me-2"></i>导出数据
                    </button>
                </div>
            </div>
        </div>

        <!-- 企业基本信息 -->
        <div class="row">
            <div class="col-12">
                <div class="card company-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h2 class="card-title">
                                <i class="fas fa-chart-line me-2"></i>{{ company.name }} - 经济数据
                            </h2>
                            <div>
                                <span class="badge bg-primary fs-6">{{ year }}年度数据</span>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="info-row">
                                    <span class="info-label">企业名称：</span> {{ company.name }}
                                </div>
                                <div class="info-row">
                                    <span class="info-label">法定代表人：</span> {{ company.legal_person or '未填写' }}
                                </div>
                                <div class="info-row">
                                    <span class="info-label">主营产品：</span> {{ company.main_products or '未填写' }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-row">
                                    <span class="info-label">数据更新时间：</span> {{ now.strftime('%Y-%m-%d %H:%M:%S') if now else '未知' }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 年度数据汇总 -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center bg-light">
                    <div class="card-body">
                        <i class="fas fa-industry fa-2x text-primary mb-2"></i>
                        <h5 class="card-title">年产值</h5>
                        <p class="card-text fs-4 text-primary" id="annualOutput">0 万元</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-light">
                    <div class="card-body">
                        <i class="fas fa-bolt fa-2x text-success mb-2"></i>
                        <h5 class="card-title">年产能</h5>
                        <p class="card-text fs-4 text-success" id="annualCapacity">0</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-light">
                    <div class="card-body">
                        <i class="fas fa-receipt fa-2x text-info mb-2"></i>
                        <h5 class="card-title">年税收</h5>
                        <p class="card-text fs-4 text-info" id="annualTax">0 万元</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-light">
                    <div class="card-body">
                        <i class="fas fa-money-bill-wave fa-2x text-warning mb-2"></i>
                        <h5 class="card-title">年投资</h5>
                        <p class="card-text fs-4 text-warning" id="annualInvestment">0 万元</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 月度数据图表 -->
        <div class="chart-container">
            <h5 class="mb-4">
                <i class="fas fa-chart-bar me-2"></i>
                {{ year }}年{{ get_data_type_name(data_type) }}月度趋势
            </h5>
            <canvas id="monthlyChart" height="100"></canvas>
        </div>

        <!-- 累计数据图表 -->
        <div class="chart-container">
            <h5 class="mb-4">
                <i class="fas fa-chart-line me-2"></i>
                {{ year }}年{{ get_data_type_name(data_type) }}累计趋势
            </h5>
            <canvas id="cumulativeChart" height="100"></canvas>
        </div>

        <!-- 月度数据表格 -->
        <div class="card company-card">
            <div class="card-body">
                <h5 class="card-title mb-4">
                    <i class="fas fa-table me-2"></i>
                    {{ year }}年{{ get_data_type_name(data_type) }}月度明细表
                </h5>
                
                <div class="table-responsive">
                    <table class="table table-hover data-table">
                        <thead>
                            <tr>
                                <th>月份</th>
                                <th>当月{{ get_data_type_name(data_type) }}</th>
                                <th>累计{{ get_data_type_name(data_type) }}</th>
                            </tr>
                        </thead>
                        <tbody>
    {% for item in data %}
    <tr>
        <td><strong>{{ item.month }}</strong></td>
        <td>{{ "%.2f"|format(item[data_type + '_actual']) }} {{ get_data_type_unit(data_type) }}</td>
        <td>{{ "%.2f"|format(item[data_type + '_cumulative_actual']) }} {{ get_data_type_unit(data_type) }}</td>
    </tr>
    {% endfor %}
</tbody>
<tfoot>
    <tr class="table-primary">
        <td><strong>年度汇总</strong></td>
        <td><strong>{{ "%.2f"|format(data|sum(attribute=data_type + '_actual')) }} {{ get_data_type_unit(data_type) }}</strong></td>
        <td><strong>{{ "%.2f"|format(data[-1][data_type + '_cumulative_actual'] if data else 0) }} {{ get_data_type_unit(data_type) }}</strong></td>
    </tr>
</tfoot>
                            <tr class="table-primary">
                                <td><strong>年度汇总</strong></td>
                                <td><strong>{{ "%.2f"|format(data|sum(attribute=data_type + '_actual')) }} {{ get_data_type_unit(data_type) }}</strong></td>
                                <td><strong>{{ "%.2f"|format(data[-1][data_type + '_cumulative_actual'] if data else 0) }} {{ get_data_type_unit(data_type) }}</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 数据录入模态框 -->
    <div class="modal fade" id="dataInputModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-edit me-2"></i>录入经济数据
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="economicDataForm">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">数据类型</label>
                                <select class="form-select" name="data_type" required>
                                    <option value="output">产值</option>
                                    <option value="capacity">产能</option>
                                    <option value="tax">税收</option>
                                    <option value="investment">固定投资</option>
                                    <option value="added_value">增加值</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">年份</label>
                                <select class="form-select" name="year" required>
                                    {% for y in years %}
                                    <option value="{{ y }}" {% if y == 2025 %}selected{% endif %}>{{ y }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">月份</label>
                                <select class="form-select" name="month" required>
                                    {% for month in range(1, 13) %}
                                    <option value="{{ month }}">{{ month }}月</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">计划值</label>
                                <input type="number" class="form-control" name="planned_value" step="0.01" min="0" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">实际值</label>
                                <input type="number" class="form-control" name="actual_value" step="0.01" min="0" required>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="submitEconomicData()">保存数据</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 季度数据模态框 -->
    <div class="modal fade" id="quarterlyModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-calendar-alt me-2"></i>{{ year }}年季度数据汇总
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        {% for data_type_name in ['output', 'capacity', 'tax', 'investment', 'added_value'] %}
                        <div class="col-md-12 mb-4">
                            <h6 class="border-bottom pb-2">{{ get_data_type_name(data_type_name) }}季度数据</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    <thead>
                                        <tr class="table-light">
                                            <th>季度</th>
                                            <th>计划值</th>
                                            <th>实际值</th>
                                            <th>完成率</th>
                                            <th>季度占比</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% if quarterly_data and data_type_name in quarterly_data %}
                                            {% for quarter in quarterly_data[data_type_name] %}
                                            <tr>
                                                <td><strong>第{{ quarter.quarter }}季度</strong></td>
                                                <td>{{ "%.2f"|format(quarter.planned_sum) }}</td>
                                                <td>{{ "%.2f"|format(quarter.actual_sum) }}</td>
                                                <td>
                                                    {% set q_rate = (quarter.actual_sum / quarter.planned_sum * 100) if quarter.planned_sum > 0 else 0 %}
                                                    <span class="badge {% if q_rate >= 100 %}bg-success{% elif q_rate >= 80 %}bg-warning{% else %}bg-danger{% endif %}">
                                                        {{ "%.1f"|format(q_rate) }}%
                                                    </span>
                                                </td>
                                                <td>
                                                    {% set total_actual = quarterly_data[data_type_name]|sum(attribute='actual_sum') %}
                                                    {% set q_percent = (quarter.actual_sum / total_actual * 100) if total_actual > 0 else 0 %}
                                                    {{ "%.1f"|format(q_percent) }}%
                                                </td>
                                            </tr>
                                            {% endfor %}
                                            <tr class="table-primary">
                                                <td><strong>年度汇总</strong></td>
                                                <td><strong>{{ "%.2f"|format(quarterly_data[data_type_name]|sum(attribute='planned_sum')) }}</strong></td>
                                                <td><strong>{{ "%.2f"|format(quarterly_data[data_type_name]|sum(attribute='actual_sum')) }}</strong></td>
                                                <td colspan="2"></td>
                                            </tr>
                                        {% else %}
                                            <tr>
                                                <td colspan="5" class="text-center text-muted">暂无数据</td>
                                            </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 数据类型名称映射
        const dataTypeNames = {
            'output': '产值',
            'capacity': '产能', 
            'tax': '税收',
            'investment': '固定投资',
            'added_value': '增加值'
        };

        // 单位映射
        const dataTypeUnits = {
            'output': '万元',
            'capacity': '',
            'tax': '万元', 
            'investment': '万元',
            'added_value': '万元'
        };

        // 更新数据类型
        function updateDataType() {
            const dataTypeSelect = document.getElementById('dataTypeSelect');
            const dataType = dataTypeSelect.value;
            
            const url = new URL(window.location.href);
            url.searchParams.set('type', dataType);
            window.location.href = url.toString();
        }

        // 更新年份
        function updateYear() {
            const yearSelect = document.getElementById('yearSelect');
            const year = yearSelect.value;
            
            const url = new URL(window.location.href);
            url.searchParams.set('year', year);
            window.location.href = url.toString();
        }

        // 提交经济数据
        function submitEconomicData() {
            const form = document.getElementById('economicDataForm');
            const formData = new FormData(form);
            
            const data = {
                monthly: [{
                    company_id: {{ company.id }},
                    data_type: formData.get('data_type'),
                    year: parseInt(formData.get('year')),
                    month: parseInt(formData.get('month')),
                    planned_value: parseFloat(formData.get('planned_value')) || 0,
                    actual_value: parseFloat(formData.get('actual_value')) || 0
                }]
            };
            
            fetch('/api/economic_data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                alert(result.message);
                if (result.success) {
                    // 关闭模态框并刷新页面
                    const modal = bootstrap.Modal.getInstance(document.getElementById('dataInputModal'));
                    modal.hide();
                    location.reload();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('数据保存失败，请检查控制台错误信息');
            });
        }

        // 导出经济数据
        function exportEconomicData() {
            alert('导出功能开发中...');
        }

        // 初始化年度汇总数据
        function initAnnualData() {
            document.getElementById('annualOutput').textContent = '{{ "%.2f"|format(data|sum(attribute="output_actual")) }} 万元';
            document.getElementById('annualCapacity').textContent = '{{ "%.2f"|format(data|sum(attribute="capacity_actual")) }}';
            document.getElementById('annualTax').textContent = '{{ "%.2f"|format(data|sum(attribute="tax_actual")) }} 万元';
            document.getElementById('annualInvestment').textContent = '{{ "%.2f"|format(data|sum(attribute="investment_actual")) }} 万元';
        }

        // 初始化图表
        function initCharts() {
            const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
            const cumulativeCtx = document.getElementById('cumulativeChart').getContext('2d');
            
            const months = {{ chart_data.months | tojson }};
            const plannedData = {{ chart_data.planned | tojson }};
            const actualData = {{ chart_data.actual | tojson }};
            const cumulativeData = {{ chart_data.cumulative_actual | tojson }};

            // 月度数据图表
            new Chart(monthlyCtx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: '计划值',
                            data: plannedData,
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: '实际值',
                            data: actualData,
                            backgroundColor: 'rgba(255, 99, 132, 0.6)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: '月度数据对比'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // 累计数据图表
            new Chart(cumulativeCtx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: '累计实际值',
                        data: cumulativeData,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: '累计数据趋势'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initAnnualData();
            initCharts();
        });
    </script>

    <!-- 模板函数 -->
    <script>
        // 获取数据类型名称
        function get_data_type_name(data_type) {
            const names = {
                'output': '产值',
                'capacity': '产能',
                'tax': '税收', 
                'investment': '固定投资',
                'added_value': '增加值'
            };
            return names[data_type] || '数据';
        }

        // 获取数据类型单位
        function get_data_type_unit(data_type) {
            const units = {
                'output': '万元',
                'capacity': '',
                'tax': '万元', 
                'investment': '万元',
                'added_value': '万元'
            };
            return units[data_type] || '';
        }
    </script>
</body>
</html>